<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.1',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="L.Dragon Blog">
<meta property="og:url" content="https://leungf.github.io/index.html">
<meta property="og:site_name" content="L.Dragon Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="L.Dragon Blog">






  <link rel="canonical" href="https://leungf.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>L.Dragon Blog</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-108011895-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108011895-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">L.Dragon Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">stupid student</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async>
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
    });
</script>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2018/10/20/c-language/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/20/c-language/" itemprop="url">
                  C 语义笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-20 10:02:21 / 修改时间：10:12:01" itemprop="dateCreated datePublished" datetime="2018-10-20T10:02:21+08:00">2018-10-20</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/20/c-language/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/20/c-language/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="const-标识符"><a href="#const-标识符" class="headerlink" title="const 标识符"></a>const 标识符</h2><ul>
<li><p>助记法：将星号读作“指针”，将const读作“常量”的话，<code>int const * n</code> 是<strong>常量指针</strong>；<code>int *const n</code> 是<strong>指针常量</strong>。</p>
</li>
<li><p><strong>常量指针</strong>：指针指向的内容是常量</p>
<ol>
<li>常量指针说的是不能通过这个指针改变变量的值，但是还是可以通过其他的引用来改变变量的值的；</li>
<li>常量指针指向的值不能改变，但是这并不是意味着指针本身不能改变，常量指针可以指向其他的地址。</li>
</ol>
</li>
<li><p><strong>指针常量</strong>：指针本身是个常量，不能在指向其他的地址</p>
<p>  指针常量指向的地址不能改变，但是地址中保存的数值是可以改变的，可以通过其他指向改地址的指针来修改。</p>
</li>
</ul>
<p><a href="https://blog.csdn.net/xingjiarong/article/details/47282255" target="_blank" rel="noopener">参考资料：C语言中const关键字的用法</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2018/10/19/digitalocean-ops/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/19/digitalocean-ops/" itemprop="url">
                  post
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-10-19 19:18:40" itemprop="dateCreated datePublished" datetime="2018-10-19T19:18:40+08:00">2018-10-19</time>
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/19/digitalocean-ops/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/19/digitalocean-ops/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2018/09/07/gpu-direct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/07/gpu-direct/" itemprop="url">
                  GPU Direct RDMA
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-09-07 21:14:16 / 修改时间：21:18:44" itemprop="dateCreated datePublished" datetime="2018-09-07T21:14:16+08:00">2018-09-07</time>
            

            
              

              
            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/07/gpu-direct/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/07/gpu-direct/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2018/07/05/cryptocurrency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/05/cryptocurrency/" itemprop="url">
                  采用矿池进行虚拟货币挖矿 v.s  独立挖矿
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-05 17:38:39" itemprop="dateCreated datePublished" datetime="2018-07-05T17:38:39+08:00">2018-07-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-10 10:26:42" itemprop="dateModified" datetime="2018-12-10T10:26:42+08:00">2018-12-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/funny/" itemprop="url" rel="index"><span itemprop="name">funny</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/05/cryptocurrency/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/05/cryptocurrency/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文简述了采用矿池挖矿和 Solo 方式挖矿的方法。
综合比较而言，对于小算力的运行环境（1 GH/s），矿池挖矿具有少量的稳定收益（nanopool 为例，约 0.08 ETH/day）。
Solo 方式在主链上与大矿池竞争算力，一天能挖到一个区块的概率不足 2%。</p>
<h1 id="矿池挖矿-v-s-独立挖矿"><a href="#矿池挖矿-v-s-独立挖矿" class="headerlink" title="矿池挖矿 v.s 独立挖矿"></a>矿池挖矿 v.s 独立挖矿</h1><h2 id="采用矿池进行挖矿"><a href="#采用矿池进行挖矿" class="headerlink" title="采用矿池进行挖矿"></a>采用矿池进行挖矿</h2><p>该方案可以看做是将算力租借给矿池，矿池根据你贡献的算力给与提成，提成的方式是将挖出的代币按照比例转移到挖矿账户上。这种方案需要的条件包括：</p>
<ol>
<li>可以挖取代币的硬件环境和挖矿软件</li>
<li>代币地址</li>
<li>可加入的合适矿池</li>
</ol>
<p>本说明以 <a href="https://nanopool.org/" target="_blank" rel="noopener">nanopool</a> 矿池和基于 MetaMask 的 Ethereum 地址为例对挖矿过程进行阐述。</p>
<p>首先，需要一个可以挖矿的硬件环境，本文默认认为已经有一台安装好 NVIDIA GPU 的服务器。
其次，准备好自己的加密货币地址。该地址可以是交易所的充币地址，可以是 MetaMask 的 Ethereum 地址，还可以是本地钱包的地址，因为最后需要矿池将代币转移给你自己。以 MetaMask 为例，直接复制 Ethernet 的 Address (Copy Address to Clipboard)，可以得到该地址。
再来，需要选择合适的挖矿软件。本文选择如下软件进行挖矿</p>
<ul>
<li><a href="https://github.com/ethereum-mining/ethminer" target="_blank" rel="noopener">ethminer</a> 作为 Ethereum 的挖矿软件</li>
<li><a href="https://github.com/fireice-uk/xmr-stak" target="_blank" rel="noopener">xmr-stak</a> 作为 Monero 的挖矿软件</li>
</ul>
<p>最后，配置好参数运行挖矿软件就可以了。相关配置参数如下：</p>
<ul>
<li><p>ethminer 的<a href="https://eth.nanopool.org/help" target="_blank" rel="noopener">配置参数</a>如下</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GPU_FORCE_64BIT_PTR=0</span><br><span class="line"><span class="built_in">export</span> GPU_MAX_HEAP_SIZE=100</span><br><span class="line"><span class="built_in">export</span> GPU_USE_SYNC_OBJECTS=1</span><br><span class="line"><span class="built_in">export</span> GPU_MAX_ALLOC_PERCENT=100</span><br><span class="line"><span class="built_in">export</span> GPU_SINGLE_ALLOC_PERCENT=100</span><br><span class="line"></span><br><span class="line">addr=....</span><br><span class="line">worker=....</span><br><span class="line">email=....</span><br><span class="line"></span><br><span class="line">./ethminer --farm-recheck 2000 -U \</span><br><span class="line">   -P stratum1+tcp://<span class="variable">$&#123;addr&#125;</span>@eth-asia1.nanopool.org:9999/<span class="variable">$&#123;worker&#125;</span>/<span class="variable">$&#123;email&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>xmr-stak 的<a href="https://xmr.nanopool.org/help" target="_blank" rel="noopener">配置参数</a>如下</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addr=....</span><br><span class="line">worker=....</span><br><span class="line">email=....</span><br><span class="line"></span><br><span class="line">./xmr-stak -O xmr-asia1.nanopool.org:14433 -u <span class="variable">$&#123;addr&#125;</span>.<span class="variable">$&#123;worker&#125;</span>/<span class="variable">$&#123;email&#125;</span> --currency monero7</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>值得注意的是上述配置中的 worker 和 email 需要正确填写，之后在 nanopool 网站上，根据这两个值可以调整最小提取额度。</p>
<h3 id="收益"><a href="#收益" class="headerlink" title="收益"></a>收益</h3><p>以 ETH 为例。
nanopool 在7月9日当天的 ETH 平均算力为 42122.7 Gh/s，每 24 小时挖到的普通块数为 686，叔块数为 315。
省略叔块的奖励，在当天 1 Gh/s 的算力情况下，可以分得的收益为 $ 5 \times 686/42122.7=0.081428778 $ ETH。</p>
<h2 id="独立节点挖矿"><a href="#独立节点挖矿" class="headerlink" title="独立节点挖矿"></a>独立节点挖矿</h2><p>独立挖矿的好处在于挖到 Eth 所得的奖励独享，坏处在于需要与大矿池竞争算力。本文中设置的挖矿拓扑为一个主网节点和多个挖矿节点。其中，主网节点用来同步全账本信息，运行 geth 程序；挖矿节点仅负责计算，运行 ethminer 程序。以下是账本同步与挖矿运行的脚步：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主网同步节点</span></span><br><span class="line">./bin/geth --rpc \</span><br><span class="line">    --syncmode <span class="string">"fast"</span> \</span><br><span class="line">    --rpcaddr <span class="string">"0.0.0.0"</span> \</span><br><span class="line">    --rpcport <span class="string">"8545"</span> \</span><br><span class="line">    --rpccorsdomain <span class="string">"*"</span> \</span><br><span class="line">    --datadir <span class="string">"/mnt/data/eth-data/data"</span> \</span><br><span class="line">    --ethash.dagdir <span class="string">"/mnt/data/eth-data/dag"</span> \</span><br><span class="line">    --etherbase <span class="string">"..."</span> \</span><br><span class="line">    --rpcapi <span class="string">"personal,db,eth,net,web3"</span> \</span><br><span class="line">    console 2&gt;&amp;1 | tee geth.log</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 主网节点开放端口</span></span><br><span class="line">sudo iptables -A INPUT -p tcp \</span><br><span class="line">    --dport 8545 -m conntrack \</span><br><span class="line">    --ctstate NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">或</span><br><span class="line">sudo ufw allow 8545</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挖矿节点</span></span><br><span class="line">wallet_addr=<span class="string">"..."</span></span><br><span class="line">ethnet_addr=<span class="string">"..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## use nvidia gpu</span></span><br><span class="line">./ethminer --farm-recheck 2000 \</span><br><span class="line">    -U -P http://<span class="variable">$&#123;wallet_addr&#125;</span>@<span class="variable">$&#123;ethnet_addr&#125;</span></span><br></pre></td></tr></table></figure>
<p>关于挖矿的可能性可以参考 <a href="https://etherscan.io/chart/hashrate" target="_blank" rel="noopener">Ethereum 的算力统计图</a>。
从15年以来，入块的最低算力是 11.5297 GH/s。
以 7月9日当天的平均算力为 292711.4538 GH/s。
如果是 1GH/s 的算力在7月9日当天挖到一个区块的可能性为 $ 1/292711.4538 \times (60 \times 60 \times 24)/15=0.019678082 $ （ETH 区块产生速率为 15 秒一个 Block）。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="http://ethereumdocch.readthedocs.io/zh/latest/mining.html" target="_blank" rel="noopener">Ethereum Homestead中文文档/挖矿</a></li>
</ol>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async>
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
    });
</script>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2018/03/23/express-mongodb-website/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/23/express-mongodb-website/" itemprop="url">
                  Express + MongoDB + PugJs 开发总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-23 00:00:00" itemprop="dateCreated datePublished" datetime="2018-03-23T00:00:00+08:00">2018-03-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-10 10:26:42" itemprop="dateModified" datetime="2018-12-10T10:26:42+08:00">2018-12-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/development/" itemprop="url" rel="index"><span itemprop="name">development</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/23/express-mongodb-website/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/23/express-mongodb-website/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前段时间用 Express (PugJS) + MongoDB + Scrapy 建了一个视频索引网站。现在简单总结一下。</p>
<h1 id="搭建网站"><a href="#搭建网站" class="headerlink" title="搭建网站"></a>搭建网站</h1><h2 id="前端开发"><a href="#前端开发" class="headerlink" title="前端开发"></a>前端开发</h2><p>首先，不得不说使用 MongoDB 建站是一件很方便的事情。后台 Model 有任何改动，只需要在 mongoose 加一个字段就可以了，相比于关系型数据库的严格类型约束，Object DB 更适合迭代开发。不过在性能上 mongodb 在后期有些吃力，特别是服务器配置不高的时候，mongodb 对内存的压力还是不小，不过这都是后话。在实现 search 和 related document 功能的时候，偷懒使用 MongoDB 的全文检索功能，性能不高，基本可以，适用于原型设计。</p>
<p>其次，Express 管理服务端逻辑。我采用传统的 MVC 将文件分为 controller、model、view 三个部分。controller 负载页面响应和数据获取，model 就是定义 mongoose 中 document 的字段，以及一些基本的存储逻辑（比如用户登录的密码验证，加密等操作），view 这部分我采用的 pugjs 进行前端页面渲染，pugjs 本质上还是 javascript 所以操作前端页面按照 JS 的逻辑来写就行了，不过开发过程中自己会把很多字符串处理逻辑都写在 PUG 中，感觉不是太好。</p>
<p>再次，就是前端 JS 的 IE 兼容问题。因为习惯使用 es2015 来写，在实际运行的时候发现在 chrome、firefox 下跑的很好，但是在 IE 上就出现各种问题。解决方法是用 babel 的 es2015-ie 插件进行兼容转换。</p>
<p>最后，Mobile 和 Destop 的支持，采用 Bootstrap 进行响应式布局，对于 CSS 不是特别熟悉，所以没有过多的研究响应式布局的细节。</p>
<h2 id="数据获取"><a href="#数据获取" class="headerlink" title="数据获取"></a>数据获取</h2><p>建站的前提是有稳定的数据源，因为自己不做 CMS，所以内容方面全部依赖爬取站点的内容质量。在此，不做详述。</p>
<p>数据爬取使用 scrapy 框架，只是使用了基本的功能。对于分布式、IP 池等没有涉及。每个站点都写了一个 Spider。从 Spider 到 Server Model 还有一段路要走，也就是说爬下来的时候需要清洗才能入库呈现。这部分的 pipeline 我是这么设计的：</p>
<ol>
<li>scrapy 爬取元数据，包括视频播放连接和元信息两部分；</li>
<li>经过 join 将视频信息和元信息进行合并，然后剔除不符合要求的数据，进入 model 库；</li>
<li>对数据进行回查，相当于是对 model 库进行清洗，主要就是剔除失效的视频连接，这部分可以定期处理（一个简单粗暴的 CMS 功能）。</li>
</ol>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>至此，站点就被搭建起来了，是不是很简单。因为没有数据维护（或者可以说是很简单的数据维护），一切数据依赖被爬取站点的数据质量。这种寄人篱下的站点建设方法不知道什么时候就会因为目标网站的升级需要更新自己的 spider 逻辑。</p>
<p>而且，随着 mongodb 中的数据越来越多，查询性能和 search 性能都在下降（前提是服务器不升级，512 MB 内存 1 CPU，6万多条记录，related search 的响应时间在 10-20 sec，find by index 的响应时间在 1-3 sec， findById 的的响应时间在 200-600 ms）。</p>
<p>此外，网站监控使用第三方服务，包括 google analysis、whos.amung.us、histats、clustrmaps 等，whos 主要监控实时的视频播放人数，histats 监控网站的访问，clustrmaps 这个主要是对旧版页面的监控。google analysis 分析整个网站的访问情况。</p>
<p><strong>SEO</strong>：设置了 sitemap 和 robots，对页面的 meta 进行了简单的设计，但效果不是太理想，现在也在摸索。</p>
<p><strong>反爬虫</strong>：还没做。</p>
<h1 id="未来发展"><a href="#未来发展" class="headerlink" title="未来发展"></a>未来发展</h1><p>这个站点就这样了吧，作为一个练手的站点，未来最多也就是更新数据源了。不过以后想用 vue 或者 react 写个单页面的网站。将前端和后端数据完全分离，现在 pug 渲染的时候，还是会将一部分 control 逻辑混写在 view 中。期待前后端数据和渲染的完全分离。</p>
<p>最后贴一个现在 clustrmaps 统计的访问情况，以示纪念。</p>
<p><img src="/images/express-mongo-clustrmaps.png" alt="clustrmaps"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2017/11/01/mac-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/01/mac-usage/" itemprop="url">
                  Mac 使用笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-11-01 00:00:00" itemprop="dateCreated datePublished" datetime="2017-11-01T00:00:00+08:00">2017-11-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-10 10:26:42" itemprop="dateModified" datetime="2018-12-10T10:26:42+08:00">2018-12-10</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/11/01/mac-usage/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/11/01/mac-usage/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用 Mac 时的一些经验分享</p>
<h1 id="关于代理"><a href="#关于代理" class="headerlink" title="关于代理"></a>关于代理</h1><h2 id="科学上网（shadowsocks-VPS）"><a href="#科学上网（shadowsocks-VPS）" class="headerlink" title="科学上网（shadowsocks + VPS）"></a>科学上网（shadowsocks + VPS）</h2><h3 id="搭建-shadowsocks-代理服务器"><a href="#搭建-shadowsocks-代理服务器" class="headerlink" title="搭建 shadowsocks 代理服务器"></a>搭建 shadowsocks 代理服务器</h3><p>在 DigitalOcean 买一个 VPS（5$/mo），然后安装 shadowsocks，网上有很多教程（例如 <a href="http://jerryzou.com/posts/shadowsocks-and-digitalocean/" target="_blank" rel="noopener">这个</a>），再次不再累述。</p>
<p>使用 supervisor 管理 shadowsocks，配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/supervisor/conf.d/shadowsocks.conf</span><br><span class="line"></span><br><span class="line">[program:shadowsocks]</span><br><span class="line">command=ssserver -c /etc/shadowsocks.json</span><br><span class="line">autorestart=true</span><br><span class="line">user=nobody</span><br><span class="line">stdout_logfile=/tmp/shadowsocks.out.log</span><br><span class="line">stderr_logfile=/tmp/shadowsocks.err.log</span><br><span class="line"></span><br><span class="line"># cat /etc/shadowsocks.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;server&quot;:&quot;::&quot;,</span><br><span class="line">    &quot;server_port&quot;:8836,</span><br><span class="line">    &quot;local_port&quot;:1080,</span><br><span class="line">    &quot;password&quot;: &quot;xx_x_xx&quot;,</span><br><span class="line">    &quot;timeout&quot;:600,</span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;,</span><br><span class="line">    &quot;fast_open&quot;: false,</span><br><span class="line">    &quot;prefer_ipv6&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本地下载安装 <a href="https://github.com/shadowsocks/shadowsocks-iOS/releases" target="_blank" rel="noopener">shadowsocks 客户端</a>，然后如下图所示进行配置。</p>
<p><img src="/images/shadowsocks-client.png" alt="shadowsocks-client"></p>
<p>参考 <a href="http://liyangliang.me/posts/2015/06/using-supervisor/" target="_blank" rel="noopener">supervisor 进程管理</a></p>
<h4 id="关于-shadowsocks-安装错误"><a href="#关于-shadowsocks-安装错误" class="headerlink" title="关于 shadowsocks 安装错误"></a>关于 shadowsocks 安装错误</h4><ol>
<li><p>ShadowSocks 启动时，会报错 <code>undefined symbol EVP_CIPHER_CTX_cleanup</code></p>
<ul>
<li><p>错误信息</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">2018-12-09 12:38:00 INFO     loading libcrypto from libcrypto.so.1.1</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;/usr/local/bin/ssserver&quot;, line 11, in &lt;module&gt;</span><br><span class="line">    sys.exit(main())</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/server.py&quot;, line 34, in main</span><br><span class="line">    config = shell.get_config(False)</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/shell.py&quot;, line 262, in get_config</span><br><span class="line">    check_config(config, is_local)</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/shell.py&quot;, line 124, in check_config</span><br><span class="line">    encrypt.try_cipher(config[&apos;password&apos;], config[&apos;method&apos;])</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/encrypt.py&quot;, line 44, in try_cipher</span><br><span class="line">    Encryptor(key, method)</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/encrypt.py&quot;, line 83, in __init__</span><br><span class="line">    random_string(self._method_info[1]))</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/encrypt.py&quot;, line 109, in get_cipher</span><br><span class="line">    return m[2](method, key, iv, op)</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/crypto/openssl.py&quot;, line 76, in __init__</span><br><span class="line">    load_openssl()</span><br><span class="line">File &quot;/usr/local/lib/python2.7/dist-packages/shadowsocks/crypto/openssl.py&quot;, line 52, in load_openssl</span><br><span class="line">    libcrypto.EVP_CIPHER_CTX_cleanup.argtypes = (c_void_p,)</span><br><span class="line">File &quot;/usr/lib/python2.7/ctypes/__init__.py&quot;, line 379, in __getattr__</span><br><span class="line">    func = self.__getitem__(name)</span><br><span class="line">File &quot;/usr/lib/python2.7/ctypes/__init__.py&quot;, line 384, in __getitem__</span><br><span class="line">    func = self._FuncPtr((name_or_ordinal, self))</span><br><span class="line">AttributeError: /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1: undefined symbol: EVP_CIPHER_CTX_cleanup</span><br></pre></td></tr></table></figure>
</li>
<li><p>原因</p>
<p>  openssl 升级到 1.1.0 以上版本，导致 shadowsocks2.8.2 启动报 undefined symbol: EVP_CIPHER_CTX_cleanup 错误。</p>
</li>
<li><p>解决方法</p>
<p>  修改 /usr/local/lib/python2.7/dist-packages/shadowsocks/crypto/openssl.py，将 CIPHER_CTX_cleanup 替换为 CIPHER_CTX_reset （应该有两处）</p>
<p><a href="https://kionf.com/2016/12/15/errornote-ss/" target="_blank" rel="noopener">参考方案</a></p>
</li>
</ul>
</li>
</ol>
<h3 id="使用-Proxifier-全局代理"><a href="#使用-Proxifier-全局代理" class="headerlink" title="使用 Proxifier 全局代理"></a>使用 Proxifier 全局代理</h3><p>shadowsocks 只能实现 socks 代理，限制了很多应用的使用。Proxifier 可以让不支持通过代理服务器工作的网络程序能通过HTTPS或SOCKS代理。
Proxifier 的使用非常简单，装好之后写 rules 就可以了。如下图所示，目前我只是将 Google Drive 的请求转发到 socks 上</p>
<p><img src="/images/proxifier-example.png" alt="proxifier-example"></p>
<h3 id="让-iOS-使用-SSH-代理访问-Web-服务"><a href="#让-iOS-使用-SSH-代理访问-Web-服务" class="headerlink" title="让 iOS 使用 SSH 代理访问 Web 服务"></a>让 iOS 使用 SSH 代理访问 Web 服务</h3><p>思路是在本地局域网内想办法建立一个 SSH 代理，然后让 iOS 设备将请求转发到这个代理上。</p>
<p>我们在一台 Macbook 和一个 iPad 的环境下实现这样的操作。具体操作步骤如下：</p>
<ol>
<li><p>在 Macbook（IP 地址是 192.168.0.8） 上搭建一个 SSH 代理</p>
<blockquote>
<p>ssh -g -N -D 192.168.0.8:8000 mypc
# -g 表示外部机器可以连到这个地址</p>
</blockquote>
</li>
<li><p>创建一个PAC文件 proxy.pac，指定如何配置proxy。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function FindProxyForURL(url, host) &#123;</span><br><span class="line">    return &quot;SOCKS 192.168.0.8:8000&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Macbook 上开启 web 服务，并将 proxy 文件放在 web 服务上。</p>
<blockquote>
<p>cp proxy.pac /Library/WebServer/Documents
sudo apachectl start</p>
</blockquote>
<p> 可以通过 <code>http://192.168.0.8/proxy.pac</code> 访问这个代理文件。</p>
</li>
<li><p>在iOS上设置。</p>
<p> 通过“Settings”-&gt;”WLAN Networks”找到现在连上的Wifi，查看details（蓝色箭头）在最下面有设置http proxy的地方。选择”Auto”, 填入 <strong>http</strong>://192.168.0.8/proxy.pac （注意：需要添加 http 头）</p>
</li>
</ol>
<p>Done！</p>
<p>这样在 Macbook 开启代理的情况下，iOS 设备可以通过该代理访问web服务。</p>
<p>参考：</p>
<ol>
<li><a href="http://www.jianshu.com/p/d006a34a343f" target="_blank" rel="noopener">Mac OS X 启用 Web 服务器</a></li>
<li><a href="http://haoxiang.org/2011/09/let-iphone-itouch-use-tunnel/" target="_blank" rel="noopener">让iOS使用SSH Tunnel</a></li>
</ol>
<h1 id="关于-WebDav"><a href="#关于-WebDav" class="headerlink" title="关于 WebDav"></a>关于 WebDav</h1><p>参考 <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-webdav-access-with-apache-on-ubuntu-14-04" target="_blank" rel="noopener">How To Configure WebDAV Access with Apache on Ubuntu 14.04</a></p>
<h1 id="关于工具"><a href="#关于工具" class="headerlink" title="关于工具"></a>关于工具</h1><ul>
<li><p>Alfred</p>
<p>  常用插件</p>
<ul>
<li>Dict</li>
<li>Kill Process</li>
<li>TerminalFinder</li>
<li>IP Address</li>
</ul>
</li>
<li><p>Atom</p>
<p>  常用插件</p>
<ul>
<li>atom-beautify</li>
<li>autocomplete-python</li>
<li>vim-mode-plus</li>
<li>platformio-ide-terminal</li>
<li>go-plus</li>
<li>Remote FTP</li>
</ul>
</li>
<li><p>Visual Studio Code</p>
</li>
<li><p>Zotero (这在 <a href="/2017/10/13/zotero-notes">Zotero 使用笔记</a> 讲过)</p>
</li>
<li><p>Vim</p>
<p>  环境配置使用 <a href="https://github.com/amix/vimrc" target="_blank" rel="noopener">The Ultimate vimrc</a></p>
</li>
<li><p>Emacs</p>
<p>  环境配置使用 <a href="https://github.com/syl20bnr/spacemacs" target="_blank" rel="noopener">spacemacs</a></p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2017/10/17/ssh-proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/17/ssh-proxy/" itemprop="url">
                  SSH 转发与代理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-17 00:00:00" itemprop="dateCreated datePublished" datetime="2017-10-17T00:00:00+08:00">2017-10-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-07 20:37:04" itemprop="dateModified" datetime="2018-09-07T20:37:04+08:00">2018-09-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/17/ssh-proxy/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/17/ssh-proxy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>利用 SSH 可以方便的搭建本地代理访问互联网。本文介绍如何跨节点访问远程主机，并在此基础上建立代理。</p>
<blockquote>
<p>Secure Shell（缩写为SSH），由IETF的网络工作小组（Network Working Group）所制定；SSH为一项创建在应用层和传输层基础上的安全协议，为计算机上的Shell（壳层）提供安全的传输和使用环境。<br>— from wikipedia</p>
</blockquote>
<h1 id="基于-SSH-的本地代理"><a href="#基于-SSH-的本地代理" class="headerlink" title="基于 SSH 的本地代理"></a>基于 SSH 的本地代理</h1><h2 id="使用-SSH-进行本地转发"><a href="#使用-SSH-进行本地转发" class="headerlink" title="使用 SSH 进行本地转发"></a>使用 SSH 进行本地转发</h2><p>在命令行执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -N -D 8000 &lt;remote-host&gt;</span><br></pre></td></tr></table></figure>
<p>这行命令的意思是在本地开放一个转发端口（-D） 8000，将发送到这个端口的信息转发（-N）给远程主机（<code>&lt;remote-host&gt;</code>）。</p>
<p>这相当于在本地建立了一个监听 8000 端口的代理服务。</p>
<p>在 Chrome 浏览器中，安装 SwitchyOmega 插件，建立一个 profile 是在本机 8000 端口使用 socks5 协议的代理，取名为 proxy8000。之后，浏览 web 的时候选择 proxy8000，便可以将请求通过 remote-host 进行转发访问了。</p>
<h2 id="SSH-代理"><a href="#SSH-代理" class="headerlink" title="SSH 代理"></a>SSH 代理</h2><p>当前从A登录到C需要先登录B再登录C，如下图所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-----+             +-----+             +-----+</span><br><span class="line">|     |             |     |             |     |</span><br><span class="line">|  A  +-----------&gt; |  B  +-----------&gt; |  C  |</span><br><span class="line">|     |             |     |             |     |</span><br><span class="line">+-----+             +-----+             +-----+</span><br></pre></td></tr></table></figure>
<p>我们的任务是通过A直接登录C</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-----+             +-----+             +-----+</span><br><span class="line">|     |             |     |             |     |</span><br><span class="line">|  A  +-------------------------------&gt; |  C  |</span><br><span class="line">|     |             |     |             |     |</span><br><span class="line">+-----+             +-----+             +-----+</span><br></pre></td></tr></table></figure>
<p>思路是建立 SSH 代理。在本地编辑 ~/.ssh/config 文件，增加 ProxyCommand 选项，像下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host target.machine</span><br><span class="line">    User          targetuser</span><br><span class="line">    HostName      target.machine</span><br><span class="line">    IdentityFile  %d/.ssh/id_rsa</span><br><span class="line">    </span><br><span class="line">    ProxyCommand  ssh proxyuser@proxy.machine -W %h:%p</span><br></pre></td></tr></table></figure>
<p>示例（<strong>注意分隔符是 tab 不是空格，粘贴后请自行修改</strong>）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host mypc</span><br><span class="line">    User          lf</span><br><span class="line">    HostName      10.2.5.160</span><br><span class="line">    IdentityFile  %d/.ssh/id_rsa</span><br><span class="line">    # ProxyCommand  ssh proxyuser@proxy.machine nc %h %p 2&gt; /dev/null</span><br><span class="line">    ProxyCommand  ssh nbtest@172.22.1.21 -W %h:%p</span><br></pre></td></tr></table></figure>
<p>相当于我们以 nbtest 用户登录到 172.22.1.21 服务器上，再以 lf 用户登录到 10.2.5.160 上。如果从本地可以免秘钥访问 nbtest@172.22.1.21 服务器，那么我们在命令行键入 <code>ssh mypc</code> 的时候直接输入 lf 的登录密码即可登录到 10.2.5.160 服务器上。</p>
<h2 id="跨节点转发"><a href="#跨节点转发" class="headerlink" title="跨节点转发"></a>跨节点转发</h2><p>与2中所述的网络结构一样。我们有些服务在 B 上不能访问，在 C 上可以访问。按照<a href="#2-ssh-代理">2</a>，在 B 上，建立 A 到 C 的代理，然后在 A 建立通过 C 的转发服务，即可访问 C 上可访问的资源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh -N -D 8000 &lt;remote-C-host&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leungf.github.io/2017/10/13/zotero-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LF">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L.Dragon Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/13/zotero-notes/" itemprop="url">
                  Zotero 使用笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-10-13 00:00:00" itemprop="dateCreated datePublished" datetime="2017-10-13T00:00:00+08:00">2017-10-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-07 20:31:46" itemprop="dateModified" datetime="2018-09-07T20:31:46+08:00">2018-09-07</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/tools/" itemprop="url" rel="index"><span itemprop="name">tools</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/13/zotero-notes/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/10/13/zotero-notes/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Zotero 是一个免费的文献管理工具。关于 Zotero 的使用推荐<a href="http://www.yangzhiping.com/" target="_blank" rel="noopener">阳志平</a>老师的博客：</p>
<ul>
<li><a href="http://www.yangzhiping.com/tech/zotero1.html" target="_blank" rel="noopener">(1) 文献管理软件Zotero基础及进阶示范</a></li>
<li><a href="http://www.yangzhiping.com/tech/zotero2.html" target="_blank" rel="noopener">(2) 作为知识管理工具的Zotero</a></li>
<li><a href="http://www.yangzhiping.com/tech/zotero3.html" target="_blank" rel="noopener">(3) 平板与社交：再谈研究辅助工具Zotero兼配套APP</a></li>
<li><a href="http://www.yangzhiping.com/tech/zotero4.html" target="_blank" rel="noopener">(4) Zotero之Zotfile插件的使用</a></li>
<li><a href="http://www.yangzhiping.com/tech/zotero5.html" target="_blank" rel="noopener">(5) 电子文献管理攻略</a></li>
<li><a href="http://www.yangzhiping.com/tech/zotero6.html" target="_blank" rel="noopener">(6) 如何批量下载PDF</a></li>
</ul>
<p>本文主要介绍几个比较有用的插件和自己平时的操作流程。</p>
<h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><h2 id="Zotfile-link"><a href="#Zotfile-link" class="headerlink" title="Zotfile (link)"></a>Zotfile (<a href="https://github.com/jlegewie/zotfile" target="_blank" rel="noopener">link</a>)</h2><p>主要功能包括，文件重命名，导出 PDF 文件到指定目录，与云存储配合实现扩平台阅读。</p>
<h2 id="Better-Bib-La-Tex（link）-已过时，zotero-支持-clipboard-导入，看-tips5"><a href="#Better-Bib-La-Tex（link）-已过时，zotero-支持-clipboard-导入，看-tips5" class="headerlink" title="Better Bib(La)Tex（link）(已过时，zotero 支持 clipboard 导入，看 tips5 )"></a>Better Bib(La)Tex（<a href="https://github.com/retorquere/zotero-better-bibtex" target="_blank" rel="noopener">link</a>）(已过时，zotero 支持 clipboard 导入，看 <a href="#tips5">tips5</a> )</h2><p>Zotero 本身不支持 Bibtex 格式导入文章条目。该插件弥补了这一不足。</p>
<p>使用时，将 Bibtex 信息复制到 clipboard 中，然后选择 <code>import from clipboard</code> 即可。</p>
<p><img src="/images/zotero-import-from-bibtex.png" alt="zotero-import-from-bibtex"></p>
<h2 id="Markdown-Here（link）"><a href="#Markdown-Here（link）" class="headerlink" title="Markdown Here（link）"></a>Markdown Here（<a href="https://github.com/adam-p/markdown-here" target="_blank" rel="noopener">link</a>）</h2><p>使用 markdown 编写文章笔记，然后用 <code>ctrl+alt+m</code> 组合键将文本变为 html。该插件需要自行<a href="https://github.com/adam-p/markdown-here#firefoxthunderbird-extension" target="_blank" rel="noopener">编译 xpi 插件包</a>。</p>
<h2 id="Google-Scholar-Citation（link）"><a href="#Google-Scholar-Citation（link）" class="headerlink" title="Google Scholar Citation（link）"></a>Google Scholar Citation（<a href="https://github.com/beloglazov/zotero-scholar-citations" target="_blank" rel="noopener">link</a>）</h2><p>查找文章的引用数，将引用信息填入 extra 字段中。</p>
<p>P.S. 最新版本的插件可能会不工作，可以使用老版本的插件(例如 <a href="https://raw.githubusercontent.com/beloglazov/zotero-scholar-citations/master/builds/zotero-scholar-citations-1.8.4-fx.xpi" target="_blank" rel="noopener">v1.8.4</a>)。如果一次更新太多会被 Google 认为是 Robot，限制访问。</p>
<h1 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h1><p>[预备] 同步到 webDAV 上（使用 <a href="https://www.digitalocean.com/" target="_blank" rel="noopener">digital ocean</a> 的私服<a href="https://www.digitalocean.com/community/tutorials/how-to-configure-webdav-access-with-apache-on-ubuntu-14-04" target="_blank" rel="noopener">搭建</a>）</p>
<ol>
<li>文件导入（一般是 connector 或 bibtex）；</li>
<li>批量下载 （<a href="https://chrome.google.com/webstore/detail/chrono-download-manager/mciiogijehkdemklbdcbfkefimifhecn" target="_blank" rel="noopener">chrono download</a>），并创建索引（Create Bibliography from Item）；</li>
<li>更新 scholar citation（Google Scholar Citation）；</li>
<li>使用 Zotfile 发送到共享文件夹 （Google Drive），使用 IPad 浏览（PDF Expert）并记录笔记然后再用 Zotfile [Get from Tablet] 同步回 Zotero；</li>
<li>在条目中创建 notes ，使用 markdown 语法做笔记（markdown here）。</li>
</ol>
<p>另外，阳的博客（6）中使用的 chrome 插件已经过时，更新为 <a href="https://chrome.google.com/webstore/detail/chrono-download-manager/mciiogijehkdemklbdcbfkefimifhecn" target="_blank" rel="noopener">Chrono Download Manager</a>。</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ol>
<li><p>递归显示 collection 中所有项目信息 (<a href="https://www.zotero.org/support/preferences/hidden_preferences" target="_blank" rel="noopener">Hidden Perferences</a>)</p>
<p> 希望实现的功能是，点击一个 collection 可以显示 sub-collection 的项目。Zotero 默认情况是不显示的。这个问题之前有人在 Zotero <a href="https://forums.zotero.org/discussion/3317/recursive-display-of-all-items-of-a-collection-and-its-sub-collections" target="_blank" rel="noopener">社区问过</a>。</p>
<p> 解决方法是通过修改 Hidden Preference 文件中的 <code>extensions.zotero.recursiveCollections</code> 字段，将其修改为 true 即可。  </p>
<p> Zotero 的配置文件包括一般可用文件和隐藏文件。隐藏文件的修改可以进入 Advanced (Panel)，选择 <code>open:config</code> 进行修改（当前 Zotero 版本是 4.0.29.15）。</p>
</li>
<li><p>显示 collection 目录下文件个数 (<a href="https://www.zotero.org/support/tips_and_tricks" target="_blank" rel="noopener">tips_and_tricks</a>)</p>
<p> To see how many items you have, click an item in the middle pane and Select All (Command-A on macOS or Control-A on Windows/Linux). A count of selected items will appear in the right-hand pane.</p>
</li>
<li><p>批量展开与折叠项目信息</p>
<p> To determine total items, including child attachments and notes, click an item and press the + (plus) key to expand all parent items before using Select All. You can press - (minus) afterward to collapse all items.</p>
</li>
<li><p>查看一个条目在哪些目录（<a href="https://www.zotero.org/support/kb/collections_containing_an_item" target="_blank" rel="noopener">tips_and_tricks</a>）</p>
<p> To see all the collections an item is in, select the item and then hold down the “Option” key (Mac OS X), “Control” key (Windows), or “Alt” key (Linux). This will highlight all collections that contain the selected item.</p>
</li>
<li><p><span id="tips5">从粘贴板导入条目</span>（<a href="https://www.zotero.org/support/kb/import_from_clipboard" target="_blank" rel="noopener">How does the Import from Clipboard feature work?</a>）</p>
<p> Import from Clipboard allows you to import items from the raw code of any supported format (RIS, BibTeX, CSL JSON, etc.). Many websites post the bibliographic data for items in their raw form. To add these items to your Zotero library, select and copy the code from the site, then import through the option in File menu in Zotero, or by the keyboard shortcut <strong>(Windows/Linux: Ctrl-Alt-Shift-I / Mac: Cmd-Option-Shift-I)</strong>.</p>
</li>
</ol>
<h1 id="TODO-List"><a href="#TODO-List" class="headerlink" title="TODO List"></a>TODO List</h1><p>关于插件：</p>
<ul>
<li><a href="https://github.com/corajr/zotero-voyant-export/" target="_blank" rel="noopener">voyant-export</a> 可以对储存在Zotero里的文字信息进行进一步分析，生成云图或者其它数据可视化图像。</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LF</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LF</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  

  
    <script id="dsq-count-scr" src="https://leungf-github-io.disqus.com/count.js" async></script>
  

  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
